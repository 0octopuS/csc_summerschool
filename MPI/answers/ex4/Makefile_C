COMP=cray

ifeq ($(COMP),cray)
CC=cc
MPICC=cc
CCFLAGS=-O3 -I/appl/opt/libpng/include
MPICCFLAGS=-O3 -I/appl/opt/libpng/include
LIBS=-L/appl/opt/libpng/lib -lpng -lz
LIBS_MPI=-L/appl/opt/libpng/lib -lpng -lz
endif

ifeq ($(COMP),gnu)
CC=gcc
MPICC=mpicc
CCFLAGS=-O3 -Wall
MPICCFLAGS=-O3 -Wall
LIBS=-lpng
LIBS_MPI=-lpng
endif

EXE_SERIAL=heat_serial
EXE_MPI=heat_mpi
OBJS_SERIAL=heat_serial.o heat_serial_main.o
OBJS_MPI=heat_mpi.o heat_mpi_main.o
OBJS_PNG=pngwriter.o


all: $(EXE_SERIAL) $(EXE_MPI)

pngwriter.o: pngwriter.c pngwriter.h
heat_serial.o: heat_serial.c heat_serial.h
heat_serial_main.o: heat_serial_main.c heat_serial.h
heat_mpi.o: heat_mpi.c heat_mpi.h
heat_mpi_main.o: heat_mpi_main.c heat_mpi.h

$(OBJS_PNG): C_COMPILER := $(CC)
$(OBJS_SERIAL): C_COMPILER := $(CC)
$(OBJS_MPI): C_COMPILER := $(MPICC)

$(EXE_SERIAL): $(OBJS_SERIAL) $(OBJS_PNG)
	$(CC) $(CCFLAGS) $(OBJS_SERIAL) $(OBJS_PNG) -o $@ $(LIBS_MPI)

$(EXE_MPI): $(OBJS_MPI) $(OBJS_PNG)
	$(MPICC) $(MPICCFLAGS) $(OBJS_MPI) $(OBJS_PNG) -o $@ $(LIBS_MPI)

%.o: %.c
	$(C_COMPILER) $(CCFLAGS) -c $< -o $@

clean:
	-/bin/rm -f $(EXE_SERIAL) $(EXE_MPI) a.out *.o *.png
