<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="CSC Summerschool">
  <title>Introduction to OpenACC</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://mlouhivu.github.io/static-engine/reveal/3.5.0/css/reveal.css">
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="theme/csc-2016/csc.css" id="theme">
  <link rel="stylesheet" href="theme/csc-2016/fonts.css">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'theme/csc-2016/pdf.css' : 'https://mlouhivu.github.io/static-engine/reveal/3.5.0/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="https://mlouhivu.github.io/static-engine/reveal/3.5.0/lib/js/html5shiv.js"></script>
  <![endif]-->
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section class="slide level1 title-slide" data-background-size="contain" data-background="theme/csc-2016/img/title-en.png">
  <h1>Introduction to OpenACC</h1>
  <p>CSC Summerschool, 2019-07</p>
</section>

<section id="what-is-openacc" class="slide level1" data-background-size="contain">
<h1>What is OpenACC ?</h1>
<ul>
<li>OpenACC defines a set of compiler directives that allow code regions to be offloaded from a host CPU to be computed on a GPU
<ul>
<li>High level GPU programming</li>
<li>Large similarity to OpenMP directives</li>
</ul></li>
<li>Supports for both C/C++ and Fortran bindings</li>
<li>More about OpenACC standard: <a href="http://www.openacc.org/">http://www.openacc.org</a></li>
</ul>
</section>
<section id="openacc-vs.-cuda" class="slide level1" data-background-size="contain">
<h1>OpenACC vs. CUDA</h1>
<ul>
<li>Why OpenACC and not CUDA?
<ul>
<li>Easier to work with</li>
<li>Porting of existing software requires less work</li>
<li>Same code can be compiled to CPU and GPU versions easily</li>
</ul></li>
<li>Why CUDA and not OpenACC?
<ul>
<li>Can access all features of the GPU hardware</li>
<li>More optimization possibilities</li>
</ul></li>
</ul>
</section>
<section id="openacc-execution-model" class="slide level1" data-background-size="contain">
<h1>OpenACC execution model</h1>
<ul>
<li>Host-directed execution with an attached accelerator
<ul>
<li>Large part of the program is usually executed by the host</li>
<li>Computationally intensive parts are <em>offloaded</em> to the accelerator that executes <em>parallel regions</em></li>
</ul></li>
<li>Accelerator can have a separate memory
<ul>
<li>OpenACC exposes the separate memories through <em>data environment</em> that defines the memory management and needed copy operations</li>
</ul></li>
</ul>
</section>
<section id="openacc-execution-model-1" class="slide level1" data-background-size="contain">
<h1>OpenACC execution model</h1>
<div class="column">
<ul>
<li>Program runs on the host CPU</li>
<li>Host offloads compute-intensive regions (<em>kernels</em>) and related data to the accelerator GPU</li>
<li>Compute kernels are executed by the GPU</li>
</ul>
</div>
<div class="column">
<figure>
<img src="img/execution-model.png" />
</figure>
</div>
</section>
<section id="openacc-data-model" class="slide level1" data-background-size="contain">
<h1>OpenACC data model</h1>
<div class="column">
<ul>
<li>If host memory is separate from accelerator device memory
<ul>
<li>host manages memory of the device</li>
<li>host copies data to/from the device</li>
</ul></li>
<li>When memories are not separate, no copies are needed (difference is transparent to the user)</li>
</ul>
</div>
<div class="column">
<figure>
<img src="img/data-movement.png" />
</figure>
</div>
</section>
<section id="openacc-directive-syntax" class="slide level1" data-background-size="contain">
<h1>OpenACC directive syntax</h1>
<table>
<thead>
<tr class="header">
<th></th>
<th>sentinel</th>
<th>construct</th>
<th>clauses</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>C/C++</td>
<td><code>#pragma acc</code></td>
<td><code>kernels</code></td>
<td><code>copy(data)</code></td>
</tr>
<tr class="even">
<td>Fortran</td>
<td><code>!$acc</code></td>
<td><code>kernels</code></td>
<td><code>copy(data)</code></td>
</tr>
</tbody>
</table>
<ul>
<li>OpenACC uses compiler directives for defining compute regions (and data transfers) that are to be performed on a GPU</li>
<li>Important constructs
<ul>
<li><code>parallel</code>, <code>kernels</code>, <code>data</code>, <code>loop</code>, <code>update</code>, <code>host_data</code>, <code>wait</code></li>
</ul></li>
<li>Often used clauses
<ul>
<li><code>if (condition)</code>, <code>async(handle)</code></li>
</ul></li>
</ul>
</section>
<section id="compiling-an-openacc-program" class="slide level1" data-background-size="contain">
<h1>Compiling an OpenACC program</h1>
<ul>
<li>Compilers that support OpenACC usually require an option that enables the feature
<ul>
<li>PGI: <code>-acc</code></li>
<li>Cray: <code>-h acc</code></li>
<li>GNU (partial support): <code>-fopenacc</code></li>
</ul></li>
<li>Without these options a regular CPU version is compiled!</li>
</ul>
</section>
<section id="openacc-conditional-compilation" class="slide level1" data-background-size="contain">
<h1>OpenACC conditional compilation</h1>
<ul>
<li>Conditional compilation with <code>_OPENACC</code> macro:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#ifdef _OPENACC</span>
device specific code
<span class="pp">#else</span>
host code
<span class="pp">#endif</span></code></pre></div>
<ul>
<li><code>_OPENACC</code> macro is defined as <em>yyyymm</em>, where <em>yyyy</em> and <em>mm</em> refer to the year and month of when the specification supported by the compiler was released</li>
</ul>
</section>
<section id="openacc-internal-control-variables" class="slide level1" data-background-size="contain">
<h1>OpenACC internal control variables</h1>
<ul>
<li>OpenACC has internal control variables
<ul>
<li><code>ACC_DEVICE_TYPE</code> controls which type of accelerator device is to be used.</li>
<li><code>ACC_DEVICE_NUM</code> controls which accelerator of the selected type is used.</li>
</ul></li>
<li>During runtime, values can be modified or queried with <code>acc_&lt;set|get&gt;_device_&lt;type|num&gt;</code></li>
<li>Values are always re-read before a kernel is launched and can be different for different kernels</li>
</ul>
</section>
<section id="runtime-api-functions" class="slide level1" data-background-size="contain">
<h1>Runtime API functions</h1>
<ul>
<li>Low-level runtime API functions can be used to
<ul>
<li>Query the number and type of devices in the system</li>
<li>Initialize/shutdown the device(s)</li>
<li>Allocate/deallocate memory on the device(s)</li>
<li>Transfer data to/from the device(s)</li>
</ul></li>
<li>Function definitions are in
<ul>
<li>C/C++ header file <code>openacc.h</code></li>
<li><code>openacc</code> Fortran module (<code>openacc_lib.h</code> header in some implementations)</li>
</ul></li>
</ul>
</section>
<section id="openacc-compute-constructs" class="slide level1 section-slide" data-background-size="contain" data-background="theme/default/img/section.png">
<h1>OpenACC compute constructs</h1>
</section>
<section id="openacc-levels-of-parallelism" class="slide level1" data-background-size="contain">
<h1>OpenACC levels of parallelism</h1>
<div class="column">
<ul>
<li>OpenACC has three levels of parallelism
<ul>
<li><strong>Vector</strong> threads work in SIMT (SIMD) fashion</li>
<li><strong>Workers</strong> compute a vector</li>
<li><strong>Gangs</strong> have one or more workers that share resources, such as streaming multiprocessor</li>
<li>Multiple gangs work independently</li>
</ul></li>
</ul>
</div>
<div class="column">
<figure>
<img src="img/vector-workers-gang.png" />
</figure>
</div>
</section>
<section id="openacc-compute-constructs-1" class="slide level1" data-background-size="contain">
<h1>OpenACC compute constructs</h1>
<ul>
<li>OpenACC includes two different approaches for defining parallel regions
<ul>
<li><code>parallel</code> defines a region to be executed on an accelerator. Work sharing <em>parallelism</em> has to be defined <em>manually</em>. Good tuning prospects.</li>
<li><code>kernels</code> defines a region to be transferred into a series of kernels to be executed in <em>sequence</em> on an accelerator. Work sharing parallelism is defined <em>automatically</em> for the separate kernels, but tuning prospects limited.</li>
</ul></li>
<li>With similar work sharing, both can perform equally well</li>
</ul>
</section>
<section id="compute-constructs-kernels" class="slide level1" data-background-size="contain">
<h1>Compute constructs: <code>kernels</code></h1>
<ul>
<li>Define a region to be transferred to a sequence of kernels for execution on the accelerator device
<ul>
<li>C/C++: <code>#pragma acc kernels [clauses]</code></li>
<li>Fortran: <code>!$acc kernels [clauses]</code></li>
</ul></li>
<li>Each separate <em>loop nest</em> inside the region will be converted into a separate <em>parallel kernel</em></li>
<li>The <em>kernels</em> will be executed in a <em>sequential</em> order</li>
</ul>
</section>
<section id="example-kernels" class="slide level1" data-background-size="contain">
<h1>Example: <code>kernels</code></h1>
<div class="column">
<h2 id="cc">C/C++</h2>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">
<span class="co">/* Compute y=a*x+y */</span>

<span class="dt">void</span> accdaxpy(<span class="dt">int</span> n, <span class="dt">double</span> a,
              <span class="dt">const</span> <span class="dt">double</span> * <span class="dt">restrict</span> x,
              <span class="dt">double</span> * <span class="dt">restrict</span> y)
{
    <span class="pp">#pragma acc kernels</span>
    <span class="cf">for</span> (<span class="dt">int</span> j=<span class="dv">0</span>; j&lt;n; ++j)
        y[j] += a  x[j];
}

<span class="co">/* An example call to accdaxpy */</span>
accdaxpy(<span class="dv">1</span>&lt;&lt;<span class="dv">16</span>, <span class="fl">3.14</span>, x, y);</code></pre></div>
</div>
<div class="column">
<h2 id="fortran">Fortran</h2>
<div class="sourceCode"><pre class="sourceCode fortran"><code class="sourceCode fortran"><span class="co">! Compute y=ax+y</span>

<span class="kw">subroutine</span> accdaxpy(n, a, x, y)
  <span class="dt">integer</span> <span class="dt">::</span> n, j
<span class="dt">  real(kind=8)</span> <span class="dt">::</span> a, x(n), y(n)

  <span class="co">!$acc kernels</span>
  <span class="kw">do</span> j <span class="kw">=</span> <span class="dv">1</span>,n
     y(j) <span class="kw">=</span> y(j) <span class="kw">+</span> a <span class="kw">*</span> x(j)
  <span class="kw">end do</span>
  <span class="co">!$acc end kernels</span>
<span class="kw">end subroutine</span> accdaxpy

<span class="co">! An example call to accdaxpy</span>
<span class="kw">call</span> accdaxpy(<span class="dv">216</span>, <span class="fl">3.14D0</span>, x, y)</code></pre></div>
</div>
</section>
<section id="compute-constructs-parallel" class="slide level1" data-background-size="contain">
<h1>Compute constructs: <code>parallel</code></h1>
<ul>
<li>Define a region to be executed on the accelerator device
<ul>
<li>C/C++: <code>#pragma acc parallel [clauses]</code></li>
<li>Fortran: <code>!$acc parallel [clauses]</code></li>
</ul></li>
<li>Without any <em>work sharing</em> constructs, the whole region is executed <em>redundantly</em> multiple times
<ul>
<li>Given a sequence of loop nests, each loop nest may be executed simultaneously</li>
</ul></li>
</ul>
</section>
<section id="work-sharing-construct-loop" class="slide level1" data-background-size="contain">
<h1>Work sharing construct: <code>loop</code></h1>
<ul>
<li>Define a loop to be parallelized
<ul>
<li>C/C++: <code>#pragma acc loop [clauses]</code></li>
<li>Fortran: <code>!$acc loop [clauses]</code></li>
<li>Must be followed by a C/C++ or Fortran loop construct.</li>
<li>Combined constructs with <code>parallel</code> and <code>kernels</code>
<ul>
<li><code>#pragma acc kernels loop</code> / <code>!$acc kernels loop</code></li>
<li><code>#pragma acc parallel loop / !$acc parallel loop</code></li>
</ul></li>
</ul></li>
<li>Similar in functionality to OpenMP <code>for/do</code> construct</li>
<li>Loop index variables are <code>private</code> variables by default</li>
</ul>
</section>
<section id="example-parallel" class="slide level1" data-background-size="contain">
<h1>Example: <code>parallel</code></h1>
<div class="column">
<h2 id="cc-1">C/C++</h2>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c">
<span class="dt">void</span> accdaxpy(<span class="dt">int</span> n, <span class="dt">double</span> a,
              <span class="dt">const</span> <span class="dt">double</span> * <span class="dt">restrict</span> x,
              <span class="dt">double</span> * <span class="dt">restrict</span> y)
{
<span class="pp">#pragma acc parallel loop</span>
    <span class="cf">for</span> (<span class="dt">int</span> j=<span class="dv">0</span>; j&lt;n; ++j)
        y[j] += a * x[j];
}

<span class="co">/* An example call to accdaxpy */</span>
accdaxpy(<span class="dv">1</span>&lt;&lt;<span class="dv">16</span>, <span class="fl">3.14</span>, x, y);</code></pre></div>
</div>
<div class="column">
<h2 id="fortran-1">Fortran</h2>
<div class="sourceCode"><pre class="sourceCode fortran"><code class="sourceCode fortran"><span class="co">! Compute y=a*x+y</span>

<span class="kw">subroutine</span> accdaxpy(n, a, x, y)
  <span class="dt">integer</span> <span class="dt">::</span> n, j
<span class="dt">  real(kind=8)</span> <span class="dt">::</span> a, x(n), y(n)

  <span class="co">!$acc parallel loop</span>
  <span class="kw">do</span> j <span class="kw">=</span> <span class="dv">1</span>,n
     y(j) <span class="kw">=</span> y(j) <span class="kw">+</span> a <span class="kw">*</span> x(j)
  <span class="kw">end do</span>
  <span class="co">!$acc end parallel loop</span>
<span class="kw">end subroutine</span> accdaxpy

<span class="co">! An example call to accdaxpy</span>
<span class="kw">call</span> accdaxpy(<span class="dv">216</span>, <span class="fl">3.14D0</span>, x, y)</code></pre></div>
</div>
</section>
<section id="compiler-diagnostics" class="slide level1 section-slide" data-background-size="contain" data-background="theme/default/img/section.png">
<h1>Compiler diagnostics</h1>
</section>
<section id="compiler-diagnostics-1" class="slide level1" data-background-size="contain">
<h1>Compiler diagnostics</h1>
<ul>
<li>Compiler diagnostics is usually the first thing to check when starting the OpenACC work
<ul>
<li>It can tell you what operations were actually performed</li>
<li>Data copies that were made</li>
<li>If and how the loops were parallelized</li>
</ul></li>
<li>The diagnostics is very compiler dependent
<ul>
<li>Compiler flags</li>
<li>Level and formatting of information</li>
</ul></li>
</ul>
</section>
<section id="pgi-compiler" class="slide level1" data-background-size="contain">
<h1>PGI compiler</h1>
<ul>
<li>Diagnostics is controlled by compiler flag <code>-Minfo=option</code></li>
<li>Useful options:
<ul>
<li><code>accel</code> -- operations related to the accelerator</li>
<li><code>all</code> -- print all compiler output</li>
<li><code>intensity</code> -- print loop computational intensity info</li>
<li><code>ccff</code> -- add extra information to the object files for use by tools</li>
</ul></li>
</ul>
</section>
<section id="example--minfo" class="slide level1" data-background-size="contain">
<h1>Example: <code>-Minfo</code></h1>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">pgcc</span> -fast -Minfo=all -c util.c
<span class="ex">malloc_2d</span>:
     <span class="ex">28</span>, Loop not vectorized: data dependency
         <span class="ex">Loop</span> unrolled 8 times
         <span class="ex">Generated</span> 1 prefetches in scalar loop
<span class="ex">eval_point</span>:
     <span class="ex">38</span>, Loop not vectorized/parallelized: potential early exits

$ <span class="ex">pgcc</span> -fast -Minfo=intensity -c util.c
<span class="ex">malloc_2d</span>:
     <span class="ex">28</span>, Intensity = 3.00
<span class="ex">eval_point</span>:
     <span class="ex">38</span>, Intensity = 8.00</code></pre></div>
</section>
<section id="summary" class="slide level1" data-background-size="contain">
<h1>Summary</h1>
<ul>
<li>OpenACC is an directive-based extension to C/Fortran programming languages for accelerators</li>
<li>Supports separate memory on the accelerator</li>
<li>Compute constructs parallel and kernels</li>
<li>Compiler diagnostics</li>
</ul>
</section>
    </div>
  </div>

  <script src="https://mlouhivu.github.io/static-engine/reveal/3.5.0/lib/js/head.min.js"></script>
  <script src="https://mlouhivu.github.io/static-engine/reveal/3.5.0/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: false,
        // Push each slide change to the browser history
        history: true,
        // Vertical centering of slides
        center: false,
        // Transition style
        transition: 'none', // none/fade/slide/convex/concave/zoom
        // Transition style for full page slide backgrounds
        backgroundTransition: 'none', // none/fade/slide/convex/concave/zoom
        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1920,
        height: 1080,

        // Optional reveal.js plugins
        dependencies: [
          { src: 'https://mlouhivu.github.io/static-engine/reveal/3.5.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'https://mlouhivu.github.io/static-engine/reveal/3.5.0/plugin/zoom-js/zoom.js', async: true },
          { src: 'https://mlouhivu.github.io/static-engine/reveal/3.5.0/plugin/notes/notes.js', async: true }
        ]
      });
    </script>
    </body>
</html>
